# Data Policy Manager - CLI #

The policy_manager.py Python script provides an command line interface to the
EUDAT Data Policy Manager (DPM)

## Dependencies ##

Based on python libxml and libxslt library (http://lxml.de/)

### Required Python Modules ###
    argparse
    urllib2
    json
    hashlib
    crontab     https://pypi.python.org/packages/source/c/crontab/crontab-0.18.tar.gz or https://github.com/josiahcarlson/parse-crontab

### Installation of python lxml ###
    MAC:
        Requires:
            Gcc Compiler
            - To install gcc, install xcode via appstore and download command line tmp ("prefereces --> downloads")
            - sudo ln -s /usr/bin/gcc-4.2 /usr/bin/gcc

            PIP
            - sudo easy_install pip

        - sudo STATIC_DEPS=true sudo pip install lxml

    SLES11 from source:
        Requires: libxml2-devel and libxslt-devel, install via yast or zypper

        - wget
        - tar -xf
        - cd
        - python setup.py install

## Configuration ##

## Using the script ##

to get help on how to use the script run "./policy_manager.py -h":

    usage: policy_manager.py [-h] -T {periodic,hook} [-t] [-v] (-su SCHEMAURL | -sp SCHEMAPATH) {http,file} ...

    EUDAT Data Policy Manager (DPM) client

    positional arguments:
      {http,file}           sub-command help
        http                Fetch policy over http
        file                Fetch policy from a file

    optional arguments:
      -h, --help            show this help message and exit
      -T {periodic,hook}, --type {periodic,hook,cli}
                            Specify if this invocation is triggered periodic,
                            via an irods hook or via the command line
      -t, --test            Test the DPM client (does not trigger an actual
                            replication)
      -v, --verbose         Run the DPM client in verbose mode
      -su --schemaurl	    fetch policy schema over http
      -sp --schemapath	    fetch policy schema from a file

Required parameters:

the -T parameter is used to specify what is invoking the script. Is it an iRODS
system hook, is it a periodic invocation running at set intervals or if it is 
started from the command line.

The script has two modes to operate, (1) the http mode and (2) the file mode. The
http mode requires and URL pointing to the policy xml file generated by the DPM 
User Interface. The file mode requires you to supply the path to the policy xml
file which is stored locally.

The -su and -sp parameters are used to specify the location of the policy schema, 
which is needed to validate the policy instance.

Optional parameters:

Supply the -v parameter to run the script in verbose mode. This will display all
kinds of information on what the scrip is doing.

Supply the -t mode to run the script in test mode. In test mode it will fetch and
parse the policy file and print to command it would execute to stdout. The actual
iRODS policy is not started. 

## Examples ##

./policy_manager.py -t -v -T cli -su http://eudat.eu/policy.template.xsd http -u https://dpm-eudat.norstore.uio.no/DPM1/DataPolicyMgr/data/output-1379580840.xml

./policy_manager.py -t -v -T cli -sp policy.template.xsd file -p ./policy_test.xml

# Upload.py #

Place this `upload.py` in `<irods>/server/bin/cmd` and make sure it is owned and executable by the iRODS user.

iRODS api hooks, configured on core.re.

`<id>` is the policy id generated by the DPM and stored in the policy.xml and policy .replicate files.
`*centerId`, identifier for the datacenter running the DPM client as defined by the DPM server
`*communityId`, community identifier on behalf of which the DPM client is running as defined by the DPM server
`*apiEndpoint`, DPM server HTTP API endpoint, accepting policy state updates

- Trigger on creation of `<id>.replicate` file.
State change: QUEUED --> RUNNING

    acPostProcForPut {
        ON($objPath like "\*.replicate") {
            *centerId = ""
            *communityId = ""
            *apiEndpoint = "https://dpm-eudat.norstore.uio.no/cgi-bin/updatepolicy.py"
            msiExecCmd("upload.py", "-u *apiEndpoint -c *centerId -C *communityId -s *sourceObject -d *destObject", "null", "null", "null", *out);
        }
    }

- Trigger on rename of `<id>.replicate` file to `<id>.replicate.success` or `<id>.replicate.failure`.
Policy state change: RUNNING --> (FINISHED | FAILED)

acPostProcForObjRename(*sourceObject,*destObject) {
        ON($objPath like "\*.replicate\*") {
                *centerId = ""
                *communityId = ""
                *apiEndpoint = "https://dpm-eudat.norstore.uio.no/cgi-bin/updatepolicy.py"
                msiExecCmd("upload.py", "-u *apiEndpoint -c *centerId -C *communityId -s *sourceObject -d *destObject", "null", "null", "null", *out);
        }
}


Data uploads to the server HTTP API endpoint have the following format and will be send as form-www/encoded name,value pairs:

{
    'id': policyId,                 policy uid, extracted from .replicate file
    'state': args.state,            policy state, extracted from .replicate file (RUNNING, FINISHED, FAILED)
    'timestamp': timestamp,         unix timestamp (seconds since EPOCH) when this script was triggered
    'center': args.center,          center id
    'community': args.community     community id
}

