# Data Policy Manager agent #

The Data Policy Manager allows to define, store, monitor policies.
A DPM policy is a set of actions applied to a set of data and triggered at a certain point in time.
A DPM agent is a client to list and retrieve DPM policies, translate them into B2SAFE operations, schedule them and provide back the status of their enforcement. It is implemented through a collection of python scripts.

Currently there is one main script: the *PolicyManager.py* python script.

Required Python Modules:

 * argparse
 * urllib
 * urllib2
 * json
 * hashlib
 * crontab
   * (https://pypi.python.org/packages/source/c/crontab/crontab-0.18.tar.gz)
   * (https://github.com/josiahcarlson/parse-crontab)
 * libxml and libxslt
   * (http://lxml.de/)
 * ConfigParser
 * time

## Configuration ##

The DPM agent can be scheduled periodically relying on the local unix crontab or controlled via iRODS, by using the msiExecCmd iRODS command. 
The typical install path is a subdirectory under the `/opt/eudat/b2safe-dpm-client` and linked in the `iRODS/service/bin/cmd` directory to point to the scripts.

Such a organization would look something like this:
```
 iRODS/server/bin/cmd/runPolicyManager.py -> /opt/eudat/b2safe-dpm-client/cmd/PolicyManager.py 
   
 /opt/eudat/b2safe-dpm-client/conf
 /opt/eudat/b2safe-dpm-client/cmd
 /opt/eudat/b2safe-dpm-client/packaging
 /opt/eudat/b2safe-dpm-client/log
 /opt/eudat/b2safe-dpm-client/test
 /opt/eudat/b2safe-dpm-client/output
 /opt/eudat/b2safe-dpm-client/rules
```

Inside the `/opt/eudat/b2safe-dpm-client/conf` directory are two files
1) `config.ini`: this file holds center specific properties and should be configured for each center.
2) `usermap.json`: this file contains the map between the global (EUDAT wide) identity of the user and the local identity on the center's B2SAFE instance.

## PolicyManager.py ##

### Using the script ###

to get help on how to use the script run `./runPolicyManager.py -h`:
```
usage: PolicyManager.py [-h] -T {periodic,hook,cli} [-t] [-v] -c CONFIG
                        (-su SCHEMAURL | -sp SCHEMAPATH)
                        {http,file,clean,update} ...

EUDAT Data Policy Manager (DPM) client

positional arguments:
  {http,file,clean,update}
                        sub-command help
    http                Fetch policy over http
    file                Fetch policy from a file
    clean               Clean the expired policies from crontab
    update              Update policy status in the central DB

optional arguments:
  -h, --help            show this help message and exit
  -T {periodic,hook,cli}, --type {periodic,hook,cli}
                        Specify if this invokation is triggered periodic or
                        via an irods hook
  -t, --test            Test the DPM client (does not trigger an actual
                        replication)
  -v, --verbose         Run the DPM client in verbose mode
  -c CONFIG, --config CONFIG
                        Path to config.ini
  -su SCHEMAURL, --schemaurl SCHEMAURL
                        The policy schema URL
  -sp SCHEMAPATH, --schemapath SCHEMAPATH
                        Path to the policy schema file

```
Required parameters:

the -T parameter is used to specify what is invoking the script. Is it an iRODS
system hook, is it a periodic invocation running at set intervals or if it is 
started from the command line.

The script has two modes to operate, (1) the http mode and (2) the file mode. The
http mode requires and URL pointing to the policy xml file generated by the DPM 
User Interface. The file mode requires you to supply the path to the policy xml
file which is stored locally.

The -su and -sp parameters are used to specify the location of the policy schema, 
which is needed to validate the policy instance.

Optional parameters:

Supply the -v parameter to run the script in verbose mode. This will display all
kinds of information on what the scrip is doing.

Supply the -t mode to run the script in test mode. In test mode it will fetch and
parse the policy file and print to command it would execute to stdout. The actual
iRODS policy is not started. 

### Examples ###

`./runPolicyManager.py -t -v -T cli -su http://eudat.eu/policy.template.xsd http -u https://dpm-eudat.norstore.uio.no/DPM1/DataPolicyMgr/data/output-1379580840.xml`

`./runPolicyManager.py -t -v -T cli -sp policy.template.xsd file -p ./policy_test.xml`

### Running the DPM client inside iRODS ###

The following rule can be run in order to execute the DPM script every 5 minutes inside the iRODS rule engine.
```
startPolicyManager {
    *Cmd="runPolicyManager.py"
    *Arg="-T cli -sp /opt/eudat/b2safe-dpm-client/conf/policy.template.xsd http -c /opt/eudat/b2safe-dpm-client/conf/config.ini"

    delay("<EF>5m</EF>") {
        msiExecCmd(*Cmd,*Arg,"null","null","null",*Result);
        msiGetStdoutInExecCmdOut(*Result,*Out);
        writeLine("serverLog","Policy manager executed [*Out]");
    }
}
INPUT null
OUTPUT ruleExecOut
```
If this rule is stored in a file called 'queuePolicyManager.r', you can start this rule with the 'irule -vF  queuePolicyManager.r' command and check it status via 'iqstat -l'.

### Data send to the DPM server ###

The `update` positional command tells to the PolicyManager to check if the expected list of policies is accepted from the local sites, already enforced or never scheduled. Then the status of each policy is updated in the central DPM DB.
Data uploads have the following format and will be send as form-www/encoded name,value pairs:
```
    {
        'id': policyId,                 policy uid, extracted from .replicate file
        'state': args.state,            policy state, extracted from .replicate file (RUNNING, FINISHED, FAILED)
        'timestamp': timestamp,         unix timestamp (seconds since EPOCH) when this script was triggered
        'center': args.center,          center id
        'community': args.community     community id
    }
```
