# Data Policy Manager Client #

The Data Policy Manager (DPM) Client is a collection of python scripts running at each EUDAT data center.

Currently there are two main scrips:
 1. The *PolicyManager.py* python script responsible for fetching policies from the DPM server.
 2. The *Upload.py script*, responsible for uploading policy execution state to the DPM server.

More information on both of these scripts can be found in the next sections.

Required Python Modules:

 * argparse
 * urllib
 * urllib2
 * json
 * hashlib
 * crontab
   * (https://pypi.python.org/packages/source/c/crontab/crontab-0.18.tar.gz)
   * (https://github.com/josiahcarlson/parse-crontab)
 * libxml and libxslt
   * (http://lxml.de/)
 * ConfigParser
 * time

## Configuration ##

The DPM client scripts will be controlled via iRODS, by using the msiExecCmd iRODS command. We typically install the DPM
scripts in a subdirectory under the iRODS/service/bin/cmd directory and use shell scripts to invoke the correct DPM client
script.

Such a organization would look something like this:

    iRODS/server/bin/cmd/
        dpm-v1/
        dpm-current/ -> dpm-v1/
        runPolicyManager.sh
        uploadPolicyState.sh

Inside the dpm-current/ directory is a file called 'config.ini'. This file holds center specific properties and should be
configured for each center.

## PolicyManager.py ##

### Using the script ###

to get help on how to use the script run "./policy_manager.py -h":

    usage: policy_manager.py [-h] -T {periodic,hook} [-t] [-v] (-su SCHEMAURL | -sp SCHEMAPATH) {http,file} ...

    EUDAT Data Policy Manager (DPM) client

    positional arguments:
      {http,file}           sub-command help
        http                Fetch policy over http
        file                Fetch policy from a file

    optional arguments:
      -h, --help            show this help message and exit
      -T {periodic,hook}, --type {periodic,hook,cli}
                            Specify if this invocation is triggered periodic,
                            via an irods hook or via the command line
      -t, --test            Test the DPM client (does not trigger an actual
                            replication)
      -v, --verbose         Run the DPM client in verbose mode
      -su --schemaurl	    fetch policy schema over http
      -sp --schemapath	    fetch policy schema from a file

Required parameters:

the -T parameter is used to specify what is invoking the script. Is it an iRODS
system hook, is it a periodic invocation running at set intervals or if it is 
started from the command line.

The script has two modes to operate, (1) the http mode and (2) the file mode. The
http mode requires and URL pointing to the policy xml file generated by the DPM 
User Interface. The file mode requires you to supply the path to the policy xml
file which is stored locally.

The -su and -sp parameters are used to specify the location of the policy schema, 
which is needed to validate the policy instance.

Optional parameters:

Supply the -v parameter to run the script in verbose mode. This will display all
kinds of information on what the scrip is doing.

Supply the -t mode to run the script in test mode. In test mode it will fetch and
parse the policy file and print to command it would execute to stdout. The actual
iRODS policy is not started. 

### Examples ###

`./policy_manager.py -t -v -T cli -su http://eudat.eu/policy.template.xsd http -u https://dpm-eudat.norstore.uio.no/DPM1/DataPolicyMgr/data/output-1379580840.xml`

`./policy_manager.py -t -v -T cli -sp policy.template.xsd file -p ./policy_test.xml`

### Running the DPM client inside iRODS ###

The following rule can be run in order to execute the DPM script every 5 minutes inside the iRODS rule engine.

    startPolicyManager {
        *Cmd="runPolicyManager.sh"
        *Arg="-T cli -sp /srv/irods/iRODS-pre-production/server/bin/cmd/policy.template.xsd http -c /srv/irods/iRODS-pre-production/server/bin/cmd/dpm-current/config.ini"

        delay("<EF>5m</EF>") {
            msiExecCmd(*Cmd,*Arg,"null","null","null",*Result);
            msiGetStdoutInExecCmdOut(*Result,*Out);
            writeLine("serverLog","Policy manager executed [*Out]");
        }
    }
    INPUT null
    OUTPUT ruleExecOut

If this rule is stored in a file called 'queuePolicyManager.r', you can start this rule with the 'irule -vF queuePolicyManager.r' command
and check it status via 'iqstat -l'.

## Upload.py ##

iRODS api hooks, configured on core.re.

Update policy state during replication policy execution:

    acPostProcForPut {
        ON($objPath like "\*.replicate") {
            #Set replication policy state when queing the policy
            *config = "/srv/irods/iRODS-pre-production/server/bin/cmd/dpm-current/config.ini"
            msiExecCmd("uploadPolicyState.sh", "-c *config -d $objPath -S QUEUED", "null", "null", "null", *out);

            delay("<PLUSET>1m</PLUSET>") {
                    #Set replication policy state when starting policy execution
                    *config = "/srv/irods/iRODS-pre-production/server/bin/cmd/dpm-current/config.ini"
                    msiExecCmd("uploadPolicyState.sh", "-c *config -d $objPath -S RUNNING", "null", "null", "null", *out);
                    processReplicationCommandFile($objPath);
            }
        }
    }

Update policy state after a replication policy is finished:

    acPostProcForObjRename(*sourceObject,*destObject) {
            ON($objPath like "\*.replicate\*") {
                    *config = "/srv/irods/iRODS-pre-production/server/bin/cmd/dpm-current/config.ini"
                    msiExecCmd("uploadPolicyState.sh", "-c *config -s *sourceObject -d *destObject", "null", "null", "null", *out);
            }
    }

### Data send to the DPM server ###

Data uploads to the server HTTP API endpoint have the following format and will be send as form-www/encoded name,value pairs:

    {
        'id': policyId,                 policy uid, extracted from .replicate file
        'state': args.state,            policy state, extracted from .replicate file (RUNNING, FINISHED, FAILED)
        'timestamp': timestamp,         unix timestamp (seconds since EPOCH) when this script was triggered
        'center': args.center,          center id
        'community': args.community     community id
    }

